
<!doctype html>
<html>

<head>
	<title>Line Chart</title>
	<title>Go Direct Sensor Readout</title>
  <meta name="description" content="Simple example of connecting to a Vernier Go DirectÂ® Sensor with WebBluetooth and logging out the default sensor value">
  <meta charset="utf-8">
  <script src="https://unpkg.com/@vernier/godirect/dist/godirect.min.umd.js"></script>
  <script src= "https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.js"></script>
  <script src="graphStyle.js" ></script>
  <!--import chart.js and GoDirect library-->
	<style>
	canvas{
		-moz-user-select: none;
		-webkit-user-select: none;
		-ms-user-select: none;
	}
	</style>
</head>

<body>
  <button id="select_device">Select Go Direct Device</button>
  <pre id="output"></pre>

	<div style="width:75%;">
		<canvas id="canvas"></canvas>
		<!--set up canvas for chart to be created-->
	</div>
	<br>
	<br>

	<script>  
    const selectDeviceBtn = document.querySelector('#select_device');
    const output = document.querySelector('#output');
		
    let sensorReadings = [];   //create global array for sensor readings to be stored
	
      
	   const selectDevice = async () => {  			//select device function, awaits connection to the device 
      try {
        gdxDevice = await godirect.selectDevice();
        output.textContent += `\n Connected to `+gdxDevice.name;
        output.textContent += `\n Reading 10 measurements \n`;
      
        gdxDevice.on('device-closed', () => {
          output.textContent += `\n\n Disconnected from `+gdxDevice.name+`\n`;
        });
        
       gdxDevice.enableDefaultSensors(); 		//enable the default sensor to use for measurements
        
        const enabledSensors = gdxDevice.sensors.filter(s => s.enabled);
        enabledSensors.forEach(sensor => {
          sensor.on('value-changed', (sensor) => {
            // Only collect 10 samples and disconnect.
            if (sensor.values.length > 10){
              gdxDevice.close();
            }
            // log the sensor name, new value and units.
            console.log(`Sensor: ${sensor.name} value: ${sensor.value} units: ${sensor.unit}`);
            // output the change to the pre tag
            sensorReadings.push(sensor.value);
			//add the sensor value to the sensorReading array  
			let unit = sensor.unit; 
            addData(config, sensor.unit);
			//use the addData function to add the sensor data to the chart
            output.textContent += `\n Sensor: ${sensor.name} value: ${sensor.value} units: ${sensor.unit}`;
			//print the sensor name, value and units
          });
        });
      
      } catch (err) {
        console.error(err);
      }
    };
       
  
      let config = { 			//chart setup
			type: 'line', 		//type of chart, could be 'line' or 'bar'
			data: {
				labels: [1,2,3,4,5,6,7,8,9,10],   //x axis labels
				datasets: [{
					label: '',
					backgroundColor: window.chartColors.red,
					borderColor: window.chartColors.red,
					data: [], 				//initial data, sensor data to be added with addData function
					fill: false,
				}]
			},
			options: {
				responsive: true,
				title: {
					display: true,
					text: 'Chart.js Line Chart'
				},
				tooltips: {
					mode: 'index',
					intersect: false,
				},
				hover: {
					mode: 'nearest',
					intersect: true
				},
				scales: {
					xAxes: [{
						display: true,
						scaleLabel: {
							display: true,
							labelString: 'Time'
						}
					}],
					yAxes: [{
						display: true,
						scaleLabel: {
							display: true,
							labelString: 'Value'
						}
					}]
				}
			}
		}; 		
    
    window.onload = function() {
			let ctx = document.getElementById('canvas').getContext('2d');
			window.myLine = new Chart(ctx, config);
		}; 

		
		let colorNames = Object.keys(window.chartColors);
	
	    
			config.data.datasets.forEach(function(dataset) {
				dataset.data.pop();   //send the data to the dataset to be added to the line
			});

      selectDeviceBtn.addEventListener('click', selectDevice); 		//start the selectDevice function when the button is pressed
		
  function addData(chart, unit) { 		//addData function to add data to the chart
    chart.data.label = unit; 			//label the chart with the units from the sensor
    chart.data.datasets.forEach((dataset) => { 		//for each data point in the data set, add the sensorReading value
        dataset.data.push(sensorReadings.pop());
    });
   window.myLine.update(); 		//update the chart line
  }
	</script>
</body>

</html>
